<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QSB Host Admin</title>
<style>
:root {
  --bg:#1a1a1e; --card:#2a2a2e; --text:#e0e0e0;
  --accent:#00bfff; --success:#28a745; --danger:#dc3545; --warn:#ffc107;
}
body { font-family:sans-serif; background:var(--bg); color:var(--text); padding:20px;}
h1,h2 { margin:0 0 10px; }
.card { background:var(--card); padding:20px; border-radius:8px; margin-bottom:20px;}
button { padding:10px 15px; border:none; border-radius:5px; cursor:pointer; margin:3px; color:#fff; }
.btn-primary{background:var(--accent);} .btn-success{background:var(--success);}
.btn-danger{background:var(--danger);} .btn-warn{background:var(--warn); color:#222;}
.full-width{width:100%;}
input[type=text]{width:calc(100%-22px);padding:10px;margin-bottom:10px;background:#111;border:1px solid #444;color:#fff;border-radius:5px;}
#players div{padding:8px; border-left:3px solid var(--accent); margin:5px 0; background:#111; border-radius:5px;}
.console {background:#111; padding:10px; border-radius:5px; height:150px; overflow-y:auto; font-family:monospace;}
.session-info {font-size:0.9em; color:#aaa;}
</style>
</head>
<body>

<h1>QSB Host Admin Panel</h1>

<div id="loginDiv" class="card">
  <h2>Sign in as Host</h2>
  <button class="btn-primary" id="steamLoginBtn">Sign in with Steam</button>
</div>

<div id="hostPanel" class="card" style="display:none;">
  <h2>Your Lobby</h2>
  <div id="hostInfo">Loading...</div>
  <div class="session-info" id="sessionInfo"></div>
  <div>Lobby uptime: <span id="lobbyUptime">0s</span></div>
  <button class="btn-danger full-width" id="removeLobbyBtn">Remove Lobby from website</button>
</div>

<div class="card">
  <h2>Players</h2>
  <input type="text" id="playerName" placeholder="Player name">
  <input type="text" id="reason" placeholder="Reason (optional)">
  <div>
    <button class="btn-danger" onclick="sendCommand('/kick')">Kick</button>
    <button class="btn-danger" onclick="sendCommand('/ban')">Ban</button>
    <button class="btn-warn" onclick="sendCommand('/mute')">Mute</button>
    <button class="btn-success" onclick="sendCommand('/unmute')">Unmute</button>
    <button class="btn-success" onclick="sendCommand('/unban')">Unban</button>
  </div>
  <div id="players">Loading...</div>
</div>

<div class="card">
  <h2>Server Actions</h2>
  <button class="btn-warn" onclick="sendCommand('/serverfreeze')">Freeze Server</button>
  <button class="btn-success" onclick="sendCommand('/unserverfreeze')">Unfreeze Server</button>
  <button class="btn-danger" onclick="sendCommand('/clearchat')">Clear All Chat</button>
</div>

<div class="card">
  <h2>Command Console</h2>
  <div class="console" id="commandConsole"></div>
</div>

<script>
// Extract JWT from URL
const params = new URLSearchParams(window.location.search);
const token = params.get('token');
if (token) {
  localStorage.setItem('qsb_jwt', token);
  window.history.replaceState({}, document.title, window.location.pathname);
}

// Authenticated fetch wrapper
async function authFetch(url, options={}) {
  const jwt = localStorage.getItem('qsb_jwt');
  if (!jwt) throw new Error('Not logged in');
  options.headers = {...(options.headers||{}), 'Authorization': `Bearer ${jwt}`};
  return fetch(url, options);
}

let hostLobby = null;
let lobbyStartTime = null;

// Steam login button
document.getElementById('steamLoginBtn').onclick = () => {
  window.location.href = 'https://server.ctksystem.com/qsbadmin/auth/steam';
};

// Check login status
async function checkAuth() {
  try {
    const res = await authFetch('https://server.ctksystem.com/qsbadmin/auth/check');
    const data = await res.json();
    if (data.authenticated) {
      document.getElementById('loginDiv').style.display = 'none';
      document.getElementById('hostPanel').style.display = 'block';
      document.getElementById('sessionInfo').textContent = `SteamID: ${data.steamId}`;
      fetchMyLobby();
    } else {
      document.getElementById('loginDiv').style.display = 'block';
      document.getElementById('hostPanel').style.display = 'none';
    }
  } catch {
    document.getElementById('loginDiv').style.display = 'block';
    document.getElementById('hostPanel').style.display = 'none';
  }
}

// Fetch lobby
async function fetchMyLobby() {
  try {
    const res = await authFetch('https://server.ctksystem.com/qsbadmin/lobby');
    if (!res.ok) {
      document.getElementById('hostInfo').textContent = 'No active lobby';
      return;
    }
    const lobby = await res.json();
    hostLobby = lobby;
    lobbyStartTime = Date.now();
    document.getElementById('hostInfo').innerHTML = `
      Lobby ID: ${lobby.lobbyId}<br>
      Players: ${lobby.players}/${lobby.maxPlayers}<br>
      Region: ${lobby.region}<br>
      Version: ${lobby.version}
    `;
  } catch {
    document.getElementById('hostInfo').textContent = 'Failed to fetch lobby';
  }
}

// Send command
function sendCommand(prefix) {
  const player = document.getElementById('playerName').value.trim();
  const reason = document.getElementById('reason').value.trim();
  let cmd = prefix;
  if (player) cmd += ' ' + player;
  if (reason && !['/serverfreeze','/unserverfreeze','/clearchat'].includes(prefix)) cmd += ' ' + reason;

  authFetch('https://server.ctksystem.com/qsbadmin/command', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({command: cmd})
  }).then(() => {
    document.getElementById('commandConsole').innerHTML += `> ${cmd}<br>`;
    // auto-clear inputs
    document.getElementById('playerName').value = '';
    document.getElementById('reason').value = '';
  }).catch(err => {
    document.getElementById('commandConsole').innerHTML += `<span style="color:red;">Failed: ${cmd}</span><br>`;
  });
}

// Remove lobby
document.getElementById('removeLobbyBtn').onclick = () => {
  authFetch('https://server.ctksystem.com/qsbadmin/lobby/remove', { method:'POST' })
  .then(() => location.reload());
};

// Lobby uptime
function updateUptime() {
  if (!lobbyStartTime) return;
  const elapsed = Math.floor((Date.now() - lobbyStartTime)/1000);
  document.getElementById('lobbyUptime').textContent = `${elapsed}s`;
}

// Periodic updates
setInterval(() => {
  checkAuth();
  updateUptime();
}, 5000); // every 5s

// Initialize
checkAuth();
</script>

</body>
</html>
